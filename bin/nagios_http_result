#!/usr/bin/perl
#
# Helper script to capture the output of a cron job to file.
#

use strict;
use File::Basename;
use Getopt::Long;
use YAML qw(Dump DumpFile);

sub usage { die "usage: " . basename($0) . " -h <hash> -n <name>\n"; }

my ($hash, $name, $output, $stdout, $user, $verbose);
usage
unless GetOptions(
  'hash|h=s'        => \$hash,
  'name|n=s'        => \$name,
  'output|o=s'      => \$output,
  'stdout'          => \$stdout,
  'user|u=s'        => \$user,
  'verbose|v+'      => \$verbose,
);
usage unless $hash && $name;

unless ($output) {
  local $/ = undef;
  $output = <>;
}
die "No output found\n" unless $output;

# Output
my $outfile = "/var/www/nagios-http/$name";
my $output = {
  hash => $hash,
  mtime => time,
  output => $output,
};
if ($stdout) {
  print Dump $output;
}
else {
  DumpFile($outfile, $output);

  # If $user is set and we're running as root, chown the $outfile
  if ($user && $> == 0) {
    my ($uid,$gid) = (getpwnam($user))[2,3];
    chown $uid, $gid, $outfile;
  }
}

